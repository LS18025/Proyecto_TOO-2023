
@{
    ViewBag.Title = "VistaProyecto";
    Layout = "~/Views/Shared/_Layout.cshtml";

}

<!-- Button trigger modal -->
<button type="button" class="btn btn-primary mt-4" data-bs-toggle="modal" data-bs-target="#exampleModal">
    Nuevo Proyecto
</button>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" >
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Nuevo Proyecto</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="modalForm">

                    <div class="card-body">
                        <div class="form-group">
                            <label for="nombreProyecto">Nombre del Proyecto</label>
                            <input type="text" class="form-control" id="nombreProyecto" name="nombreProyecto" placeholder="Ingrese el nombre del proyecto" required>
                        </div>
                        <div class="form-group">
                            <label for="descripcion">Descripción</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" placeholder="Ingrese una descripción del proyecto" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="fechaIni">Fecha de Inicio</label>
                            <input type="date" class="form-control" id="fechaIni" name="fechaIni" required>
                        </div>
                        <div class="form-group">
                            <label for="fechaFin">Fecha de Finalización</label>
                            <input type="date" class="form-control" id="fechaFin" name="fechaFin" required>
                        </div>
                    </div>

                    <!-- /.card-body -->


                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" onclick="Guardar()">Guardar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Editar Proyecto</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="modalForm" method="post">

                    <div class="card-body">
                        <div class="form-group">
                            <label for="nombreProyecto">Nombre del Proyecto</label>
                            <input type="text" class="form-control" id="nombreProyecto1" name="nombreProyecto" placeholder="Ingrese el nombre del proyecto" required>
                        </div>
                        <div class="form-group">
                            <label for="descripcion">Descripción</label>
                            <textarea class="form-control" id="descripcion1" name="descripcion" placeholder="Ingrese una descripción del proyecto" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="fechaIni">Fecha de Inicio</label>
                            <input type="date" class="form-control" id="fechaIni1" name="fechaIni" required>
                        </div>
                        <div class="form-group">
                            <label for="fechaFin">Fecha de Finalización</label>
                            <input type="date" class="form-control" id="fechaFin1" name="fechaFin" required>
                        </div>
                        <input type="hidden" id="editIdProyecto" value="">
                        <input type="hidden" id="editNombreProyecto" value="">
                        <input type="hidden" id="editDescripcion" value="">
                        <input type="hidden" id="editFechaIni" value="">
                        <input type="hidden" id="editFechaFin" value="">

                    </div>

                    <!-- /.card-body -->


                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" onclick="Editar()">Guardar</button>
            </div>
        </div>
    </div>
</div>


<div class="card mt-4">
    <div class="card-header">
        <h3 class="card-title">Lista de Proyectos</h3>
    </div>
    <!-- /.card-header -->
    <div class="card-body table-responsive p-3">
        <table id="tablaProyectos">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Fecha de Inicio</th>
                    <th>Fecha de Finalización</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

    </div>
    <!-- /.card-body -->
</div>

@section scripts {
    <script>
        var tablaProyecto;
        var info;
        function Guardar() {
            // Evita la acción predeterminada del formulario (recargar la página).

            var proyecto = {
                nombreProyecto: $("#nombreProyecto").val(),
                descripcion: $("#descripcion").val(),
                fechaIni: $("#fechaIni").val(),
                fechaFin: $("#fechaFin").val(),
            }

            $.ajax({
                url: "@Url.Action("AgregarProyecto", "Proyecto")",
                type: "POST",
                data: JSON.stringify(proyecto), // No necesitas envolverlo en un objeto { Proyecto: proyecto }
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    // Aquí puedes manejar la respuesta del servidor, como mostrar un mensaje de éxito o error.
                    if (data.success) {

                        $("#exampleModal").modal("hide"); // Cierra el modal
                        tablaProyecto.ajax.reload();
                        // Aquí puedes recargar la tabla u otra actualización si es necesario.
                    } else {
                        alert("Error: " + data.message); // Muestra un mensaje de error
                    }
                }
            });
        }
        function Editar() {

                // Obtén los datos del formulario de edición
                var proyectoEditado = {
                    idProyecto: $("#editIdProyecto").val(),
                    nombreProyecto: $("#nombreProyecto1").val(),
                    descripcion: $("#descripcion1").val(),
                    fechaIni: $("#fechaIni1").val(),
                    fechaFin: $("#fechaFin1").val(),
                    // Asegúrate de incluir el ID del proyecto que se está editando

                };

                jQuery.ajax({
                    url: "@Url.Action("EditarProyecto", "Proyecto")",
                    type: "POST",
                    data: JSON.stringify(proyectoEditado),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        if (data.success) {
                            $("#exampleModal2").modal("hide"); // Cierra el modal de edición
                            tablaProyecto.ajax.reload();
                        } else {
                            alert("Error al actualizar el Proyecto: " + data.message);
                        }
                    }
                });

        }
        $(document).ready(function () {
            $('#exampleModal').on('show.bs.modal', function () {
                // Restablecer los campos del modal
                $("#nombreProyecto").val("");
                $("#descripcion").val("");
                $("#fechaIni").val("");
                $("#fechaFin").val("");

            });

            tablaProyecto = $('#tablaProyectos').DataTable({
                responsive: true,
                autoWidth: true,
                ordering: false,
                "ajax": {
                    url: "@Url.Action("ListarProyectos", "Proyecto")",
                    type: "GET",
                    dataType: "json",
                },
                "columns": [
                    { "data": "nombreProyecto", "type": "auto" },
                    { "data": "descripcion", "type": "auto" },
                    {
                        "data": "fechaIni",
                        "render": function (data) {
                            // Formatea la fecha antes de mostrarla
                            return new Date(parseInt(data.substr(6))).toLocaleDateString();
                        }
                    },
                    {
                        "data": "fechaFin",
                        "render": function (data) {
                            // Formatea la fecha antes de mostrarla
                            return new Date(parseInt(data.substr(6))).toLocaleDateString();
                        }
                    },
                    {
                        "render": function (data, type, row) {
                            // Los datos de la fila actual están en el objeto "row"
                            // Debes acceder a los campos como row.nombre, row.apellido, row.correo, etc.

                            // Botón de edición
                            var editarBtn = '<button class="btn btn-primary btn-editar mr-2" data-idProyecto="' + row.id + '"><i class="fas fa-pen"></i></button>';

                            // Botón de borrado
                            // Botón de borrado
                            var borrarBtn = '<button class="btn btn-danger btn-borrar" data-idproyecto="' + row.id + '"><i class="fas fa-trash"></i></button>';

                            return editarBtn + borrarBtn;
                        }
                    }

                    // Agrega más columnas según tus necesidades
                ],
                "language": {
                    "search": "Buscar:",
                    "lengthMenu": "Registros _MENU_",
                    "emptyTable": "No hay datos disponibles en la tabla",
                }
            });


            $('#tablaProyectos tbody').on('click', '.btn-editar', function () {
                var filaSeleccionada = $(this).closest("tr").prev();
                info = tablaProyecto.row(filaSeleccionada).data();
                //elementos ocultos
                $("#editIdProyecto").val(info.idProyecto);
                $("#editNombreProyecto").val(info.nombreProyecto);
                $("#editDescripcion").val(info.descripcion);
                $("#editFechaIni").val(info.fechaIni);
                $("#editFechaFin").val(info.fechaFin);

                $("#nombreProyecto1").val(info.nombreProyecto)
                $("#descripcion1").val(info.descripcion)
                var fechaIni = new Date(parseInt(info.fechaIni.substr(6)));
                var fechaFin = new Date(parseInt(info.fechaFin.substr(6)));

                // Establece los valores de fecha en los campos del modal
                $("#fechaIni1").val(fechaIni.toISOString().split('T')[0]);
                $("#fechaFin1").val(fechaFin.toISOString().split('T')[0]);

                $("#exampleModal2").modal("show");

            });
            $('#tablaProyectos').on('click', '.btn-borrar', function () {

                var userSeleccionado = $(this).closest("tr").prev();
                var info2 = tablaProyecto.row(userSeleccionado).data();
                swal({
                    title: "Estas seguro?",
                    text: "Deseas eliminar el proyecto?",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonClass: "btn-danger",
                    confirmButtonText: "Si!",
                    cancelButtonText: "No",
                    closeOnConfirm: true
                },
                    function () {
                        
                            jQuery.ajax({
                                url: "@Url.Action("BorrarProyecto", "Proyecto")",
                                type: "POST",
                                data: JSON.stringify({ idProyecto: info2.idProyecto }),
                                dataType: "json",
                                contentType: "application/json; charset=utf-8",
                                success: function (data) {
                                    if (data.success) {
                                        
                                        // Recargar la tabla después de eliminar el proyecto
                                        tablaProyecto.ajax.reload();
                                    } else {
                                        swal("Error", "Error al eliminar el proyecto: " + data.message, "error");
                                    }
                                }
                            });
                        
                    });

            });
            



        });
       
    </script>
}